stages:
  - test
  - publish
  - set-amd64-to-latest

run-pre-commit:
  stage: test
  image: explorviz/pre-commit:latest
  tags:
    - exec-docker
  script:
    - pre-commit run --all-files --config .pre-commit-config.yaml

build-petclinic-amd64:
  stage: publish
  tags:
    - exec-docker
  only:
    - schedules
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${DOCKERHUB_USER}:${DOCKERHUB_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context=$CI_PROJECT_DIR/example-applications/petclinic-demo --dockerfile=$CI_PROJECT_DIR/example-applications/petclinic-demo/Dockerfile --destination=$DOCKERHUB_ORGA/$DOCKERHUB_IMAGE_NAME:amd64

build-demo-supplier-amd64:
  stage: publish
  tags:
    - exec-docker
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      changes:
        - demo-supplier/app.js
        - demo-supplier/Dockerfile
        - demo-supplier/package.json
        - demo-supplier/user.json
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"auth\":\"$(echo -n ${DOCKERHUB_USER}:${DOCKERHUB_PASSWORD} | base64)\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor --context=$CI_PROJECT_DIR/demo-supplier --dockerfile=$CI_PROJECT_DIR/demo-supplier/Dockerfile --destination=$DOCKERHUB_ORGA/demo-supplier:amd64

publish-multi-arch:
  image:
    name: curlimages/curl:latest
    entrypoint: [""]
  stage: set-amd64-to-latest
  tags:
    - exec-docker
  only:
    - schedules
  variables:
    MANIFEST_PLATFORMS: "linux/amd64"
  before_script:
    - GHPRJ="https://github.com/estesp/manifest-tool"
    - VERSION="v1.0.3"
    - ARTIFACT="manifest-tool-linux-amd64"
    - URL="$GHPRJ/releases/download/$VERSION/$ARTIFACT"
    - curl -L -o manifest-tool $URL
    - chmod +x manifest-tool
  script:
    - ./manifest-tool
      --username ${DOCKERHUB_USER}
      --password ${DOCKERHUB_PASSWORD}
      push from-args
      --platforms ${MANIFEST_PLATFORMS}
      --template ${DOCKERHUB_ORGA}/${DOCKERHUB_IMAGE_NAME}:ARCH
      --target ${DOCKERHUB_ORGA}/${DOCKERHUB_IMAGE_NAME}:latest
    - ./manifest-tool
      --username ${DOCKERHUB_USER}
      --password ${DOCKERHUB_PASSWORD}
      push from-args
      --platforms ${MANIFEST_PLATFORMS}
      --template ${DOCKERHUB_ORGA}/demo-supplier:ARCH
      --target ${DOCKERHUB_ORGA}/demo-supplier:latest
